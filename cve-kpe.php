<?php
require __DIR__ . '/auth.php';

$autoloadReady = false;
$autoloadPaths = [
    __DIR__ . '/vendor/autoload.php',
    __DIR__ . '/backend/vendor/autoload.php',
    '/var/www/backend/vendor/autoload.php'
];

foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require_once $autoloadPath;
        $autoloadReady = true;
        $autoloadLoadedPath = $autoloadPath;
        break;
    }
}

use PhpOffice\PhpSpreadsheet\IOFactory;
use PhpOffice\PhpSpreadsheet\Reader\Csv;
use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xls;

$pageTitle = 'CVE КПЭ';
$activePage = 'cve-kpe';

$errors = [];
$logMessages = [];
$autoloadLoadedPath = $autoloadLoadedPath ?? null;
$downloadUrl = null;
$outputFilename = null;

$iniSizeToBytes = static function (string $value): int {
    $value = trim($value);
    if ($value === '') {
        return 0;
    }

    $unit = strtolower(substr($value, -1));
    $number = (float) $value;

    switch ($unit) {
        case 'g':
            $number *= 1024;
            // no break
        case 'm':
            $number *= 1024;
            // no break
        case 'k':
            $number *= 1024;
            break;
    }

    return (int) $number;
};

$loadSpreadsheet = static function (array $file): ?\PhpOffice\PhpSpreadsheet\Spreadsheet {
    if (!isset($file['tmp_name'], $file['name']) || $file['tmp_name'] === '') {
        return null;
    }

    $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));

    try {
        if ($extension === 'csv') {
            $reader = new Csv();
            $sample = file_get_contents($file['tmp_name']);
            if ($sample !== false) {
                $semicolonCount = substr_count($sample, ';');
                $commaCount = substr_count($sample, ',');
                $reader->setDelimiter($semicolonCount > $commaCount ? ';' : ',');
            }
        } else {
            $reader = IOFactory::createReaderForFile($file['tmp_name']);
        }
    } catch (Throwable $error) {
        return null;
    }

    if (isset($reader)) {
        $reader->setReadDataOnly(true);
        return $reader->load($file['tmp_name']);
    }

    return null;
};

$extractRows = static function (\PhpOffice\PhpSpreadsheet\Spreadsheet $spreadsheet, array $columns): array {
    $sheet = $spreadsheet->getActiveSheet();
    $highestRow = $sheet->getHighestRow();
    $rows = [];

    for ($row = 2; $row <= $highestRow; $row += 1) {
        $rowData = [];
        $hasValue = false;
        foreach ($columns as $column) {
            $value = trim((string) $sheet->getCell($column . $row)->getValue());
            if ($value !== '') {
                $hasValue = true;
            }
            $rowData[$column] = $value;
        }

        if ($hasValue) {
            $rows[] = $rowData;
        }
    }

    return $rows;
};

$contentLength = isset($_SERVER['CONTENT_LENGTH']) ? (int) $_SERVER['CONTENT_LENGTH'] : 0;
$postMaxSize = $iniSizeToBytes((string) ini_get('post_max_size'));

if ($_SERVER['REQUEST_METHOD'] === 'POST' && $postMaxSize > 0 && $contentLength > $postMaxSize) {
    $errors[] = 'Размер запроса превышает лимит загрузки на сервере. Уменьшите файл или увеличьте post_max_size.';
    $logMessages[] = 'Размер запроса превышает post_max_size.';
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && !$autoloadReady && empty($errors)) {
    $errors[] = 'Не удалось найти зависимости PhpSpreadsheet. Установите зависимости composer.';
    $logMessages[] = 'Автозагрузчик PhpSpreadsheet не найден. Проверьте установку composer.';
    $logMessages[] = 'Пути для автозагрузчика: ' . implode(', ', $autoloadPaths) . '.';
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && $autoloadReady && empty($errors)) {
    $logMessages[] = $autoloadLoadedPath
        ? sprintf('Автозагрузчик PhpSpreadsheet найден: %s.', $autoloadLoadedPath)
        : 'Автозагрузчик PhpSpreadsheet найден.';
    $requiredFiles = ['glpi' => 'GLPI', 'redscan' => 'Redscan', 'kesl' => 'KESL'];
    $spreadsheets = [];

    foreach ($requiredFiles as $key => $label) {
        if (!isset($_FILES[$key]) || $_FILES[$key]['error'] !== UPLOAD_ERR_OK) {
            $errors[] = "Не удалось загрузить файл {$label}.";
            $logMessages[] = "Ошибка загрузки файла {$label}.";
            continue;
        }

        $spreadsheet = $loadSpreadsheet($_FILES[$key]);
        if ($spreadsheet === null) {
            $errors[] = "Файл {$label} имеет неподдерживаемый формат.";
            $logMessages[] = "Файл {$label} не удалось прочитать как таблицу.";
            continue;
        }

        $spreadsheets[$key] = $spreadsheet;
        $logMessages[] = "Файл {$label} успешно загружен.";
    }

    if (!$errors && count($spreadsheets) === count($requiredFiles)) {
        $logMessages[] = 'Начато чтение данных таблиц.';
        $glpiRows = $extractRows($spreadsheets['glpi'], ['A', 'D', 'G']);
        $redscanRows = $extractRows($spreadsheets['redscan'], ['C', 'F', 'G', 'I', 'K']);
        $keslRows = $extractRows($spreadsheets['kesl'], ['A', 'F', 'H', 'I']);
        $logMessages[] = 'Извлечены строки из GLPI, Redscan и KESL.';

        $glpiMap = [];
        foreach ($glpiRows as $row) {
            $key = $row['D'] ?? '';
            if ($key !== '') {
                $glpiMap[$key] = [
                    'asset' => $row['A'] ?? '',
                    'segment' => $row['G'] ?? ''
                ];
            }
        }
        $logMessages[] = 'Сформировано сопоставление GLPI.';

        $outputRows = [];
        foreach ($redscanRows as $row) {
            $outputRows[] = [
                'node' => $row['C'] ?? '',
                'cve' => $row['I'] ?? '',
                'published' => $row['K'] ?? '',
                'cvss' => $row['G'] ?? '',
                'severity' => $row['F'] ?? '',
                'internal' => '',
                'exploit' => '',
                'detected' => '',
                'resolved' => '',
                'comment' => ''
            ];
        }

        foreach ($keslRows as $row) {
            $outputRows[] = [
                'node' => $row['H'] ?? '',
                'cve' => $row['I'] ?? '',
                'published' => $row['F'] ?? '',
                'cvss' => '',
                'severity' => $row['A'] ?? '',
                'internal' => '',
                'exploit' => '',
                'detected' => '',
                'resolved' => '',
                'comment' => ''
            ];
        }
        $logMessages[] = 'Сформирована нормализованная таблица.';

        foreach ($outputRows as $index => $row) {
            $node = $row['node'];
            if ($node !== '' && isset($glpiMap[$node])) {
                $segment = $glpiMap[$node]['segment'] ?? '';
                $internal = '';

                switch ($segment) {
                    case 'Office Productivity':
                        $internal = 'Среднее';
                        break;
                    case 'Business Operational':
                    case 'Test Environment':
                        $internal = 'Средняя';
                        break;
                    case 'Business Critical':
                        $internal = 'Высокая';
                        break;
                }

                $outputRows[$index]['internal'] = $internal;

                $asset = $glpiMap[$node]['asset'] ?? '';
                if ($asset !== '') {
                    $outputRows[$index]['node'] = sprintf('%s (%s)', $node, $asset);
                }
            }
        }
        $logMessages[] = 'Заполнены внутренние оценки и данные GLPI.';

        $spreadsheet = new Spreadsheet();
        $sheet = $spreadsheet->getActiveSheet();

        $headers = [
            'Узел',
            'CVE-идентификатор',
            'Дата публикации информации об уязвимости',
            'Оценка уязвимости CVSSv3',
            'Оценка критичности согласно CVSSv3',
            'Оценка критичности согласно внутренней методики',
            'Наличие exploit/workaround',
            'Дата обнаружения',
            'Дата устранения (фактическая или запланированная)',
            'Комментарий'
        ];

        $sheet->fromArray($headers, null, 'A1');

        $rowIndex = 2;
        foreach ($outputRows as $row) {
            $sheet->setCellValue('A' . $rowIndex, $row['node']);
            $sheet->setCellValue('B' . $rowIndex, $row['cve']);
            $sheet->setCellValue('C' . $rowIndex, $row['published']);
            $sheet->setCellValue('D' . $rowIndex, $row['cvss']);
            $sheet->setCellValue('E' . $rowIndex, $row['severity']);
            $sheet->setCellValue('F' . $rowIndex, $row['internal']);
            $sheet->setCellValue('G' . $rowIndex, $row['exploit']);
            $sheet->setCellValue('H' . $rowIndex, $row['detected']);
            $sheet->setCellValue('I' . $rowIndex, $row['resolved']);
            $sheet->setCellValue('J' . $rowIndex, $row['comment']);
            $rowIndex += 1;
        }

        $outputDir = __DIR__ . '/uploads/cve-kpe';
        if (!is_dir($outputDir) && !mkdir($outputDir, 0775, true) && !is_dir($outputDir)) {
            $errors[] = 'Не удалось создать папку для результата.';
            $logMessages[] = 'Ошибка создания папки для результата.';
        } else {
            $outputFilename = 'cve-kpe-' . date('Ymd-His') . '.xls';
            $outputPath = $outputDir . '/' . $outputFilename;
            $writer = new Xls($spreadsheet);
            $writer->save($outputPath);
            $downloadUrl = '/uploads/cve-kpe/' . $outputFilename;
            $logMessages[] = "Файл сформирован: {$outputFilename}.";
        }
    }
}

require __DIR__ . '/partials/layout-start.php';
require __DIR__ . '/frontend/cve-kpe.php';
require __DIR__ . '/partials/layout-end.php';
